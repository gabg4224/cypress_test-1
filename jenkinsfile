pipeline {
  agent any

  tools {
    nodejs 'node24' 
  }

  environment {
    CYPRESS_user_mail = credentials('user_mail') // usa un secret en Jenkins
    CYPRESS_user_password = credentials('user_password')
  }

  stages {
    stage('Checkout') {
      steps {
        git 'https://github.com/gabg4224/cypress_test-1.git'
      }
    }

    stage('Install dependencies') {
      steps {
        bat  'npm ci'
      }
    }

    stage('Run Cypress tests') {
      steps {
        bat  'test:qa'
      }
    }

    stage('Generate Reports') {
      steps {
        bat  'npx mochawesome-merge cypress/reports/*.json > mochawesome.json'
        bat  'npx marge mochawesome.json --reportDir cypress/reports --reportFilename index.html'
      }
    }

    stage('Publish Report') {
      steps {
        publishHTML([allowMissing: false,
          alwaysLinkToLastBuild: true,
          keepAll: true,
          reportDir: 'cypress/reports',
          reportFiles: 'index.html',
          reportName: 'Cypress Report'])
      }
    }
  }
}
